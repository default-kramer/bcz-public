[gd_scene load_steps=7 format=2]

[ext_resource path="res://Sprites/vat-fg.png" type="Texture" id=1]
[ext_resource path="res://Sprites/vat-bg.png" type="Texture" id=2]
[ext_resource path="res://Sprites/vat-liquid.png" type="Texture" id=3]

[sub_resource type="CSharpScript" id=1]
resource_name = "PenaltyViewerControl"
script/source = "using Godot;
using System;

public class PenaltyViewerControl : Control
{
    // Declare member variables here. Examples:
    // private int a = 2;
    // private string b = \"text\";

    // Called when the node enters the scene tree for the first time.
    public override void _Ready()
    {
        
    }

//  // Called every frame. 'delta' is the elapsed time since the previous frame.
//  public override void _Process(float delta)
//  {
//      
//  }
}
"

[sub_resource type="Shader" id=2]
code = "shader_type canvas_item;

uniform float crop = 0.8; // crops bottom of image

vec2 random2(vec2 p) {
    return fract(sin(vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3))))*43758.5453);
}

void fragment() {
    vec2 scale = vec2(25.0, 170.0);
    vec2 st = UV * scale;
    vec2 i_st = floor(st);
    vec2 f_st = fract(st);
    float m_dist = 100.;  // minimum distance
    vec2 uv = st;
    for(int y = -1; y <= 1; ++y){
        for(int x = -1; x <= 1; ++x){
             vec2 neighbor = vec2(float(x),float(y));
            vec2 point = random2(i_st + neighbor);
            point = 0.5 + 0.5*sin(TIME + 6.2831*point);
            vec2 diff = neighbor + point - f_st;
            float dist = length(diff);

            // Keep the closer distance
            if(dist < m_dist){
             m_dist = dist;
                uv = st + diff;
            }
        }
    }
    uv /= scale;
    if (UV.y > crop) {
        COLOR = vec4(0.0, 0.0, 0.0, 0.0);
    } else {
        COLOR = texture(TEXTURE, uv);
    }
}"

[sub_resource type="ShaderMaterial" id=3]
shader = SubResource( 2 )
shader_param/crop = 0.8

[node name="Control" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0
margin_right = -1024.0
margin_bottom = -600.0
rect_min_size = Vector2( 100, 500 )
script = SubResource( 1 )

[node name="TankBackground" type="Sprite" parent="."]
position = Vector2( 50, 250 )
texture = ExtResource( 2 )

[node name="Sprite2" type="Sprite" parent="."]
position = Vector2( 50, 250 )
z_index = 2
texture = ExtResource( 1 )

[node name="Liquid" type="Sprite" parent="."]
material = SubResource( 3 )
position = Vector2( 50, 250 )
z_index = 1
texture = ExtResource( 3 )
